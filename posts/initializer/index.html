<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>How Compilers Initialize C style array | 6cdh's Blog</title><meta property='og:title' content="How Compilers Initialize C style array - 6cdh's Blog"><meta property='og:description' content='In C++11, you can initialize all members of a C-style array to zero.'><meta property='og:url' content='https://6cdh.github.io/posts/initializer/'><meta property='og:site_name' content="6cdh's Blog"><meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/b8cddc4add92aa9aa4ad41498604c028?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='c++'><meta property='article:published_time' content='2021-04-13T16:39:06+08:00'><meta property='article:modified_time' content='2021-04-13T16:39:06+08:00'><meta name=twitter:card content='summary'><meta name=twitter:site content='@'><meta name=twitter:creator content='@'><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://6cdh.github.io/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://6cdh.github.io/posts/initializer/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://6cdh.github.io/><h1 id=nav-heading class="title is-4">6cdh's Blog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/6cdh target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</i></span></a><a class=level-item aria-label=email href=mailto:cd6cdh@gmail.com target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/c++/>#c++</a></div><h2 class="subtitle is-6">April 13, 2021</h2><h1 class=title>How Compilers Initialize C style array</h1><div class=content><p>In C++11, you can initialize all members of a C-style array to zero.</p><p>For example, you can</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span> a<span style=color:#888>[</span><span style=color:#444>10</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{</span><span style=color:#444>0</span><span style=color:#888>};</span> <span style=color:#888;font-style:italic>// all elements 0
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>// or
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=color:#2838b0;font-style:italic>int</span> a<span style=color:#888>[</span><span style=color:#444>10</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{};</span> <span style=color:#888;font-style:italic>// all elements 0
</span></span></span></code></pre></div><p>But how the compilers implement it?</p><p>Assume we have this code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0;font-style:italic>void</span> <span style=color:#785840>f</span><span style=color:#888>()</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>int</span> a<span style=color:#888>[</span><span style=color:#444>10</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{};</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>With clang 11.0.1, we get this asm code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#785840>f</span><span style=color:#888>():</span>                                  <span style=color:#888;font-style:italic># @f()
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rbp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rbp</span><span style=color:#888>,</span> <span style=color:#b85820>rsp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>sub</span>     <span style=color:#b85820>rsp</span><span style=color:#888>,</span> <span style=color:#444>48</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>xor</span>     <span style=color:#b85820>esi</span><span style=color:#888>,</span> <span style=color:#b85820>esi</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>lea</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#888>[</span><span style=color:#b85820>rbp</span> <span style=color:#888>-</span> <span style=color:#444>48</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>edx</span><span style=color:#888>,</span> <span style=color:#444>40</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>memset</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>add</span>     <span style=color:#b85820>rsp</span><span style=color:#888>,</span> <span style=color:#444>48</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rbp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span></code></pre></div><p>As you see, clang use <code>memset</code> to initialize the array.</p><p>With gcc 10.3, we get this asm code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#785840>f</span><span style=color:#888>():</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rbp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rbp</span><span style=color:#888>,</span> <span style=color:#b85820>rsp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>QWORD</span> <span style=color:#b85820>PTR</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-48</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>QWORD</span> <span style=color:#b85820>PTR</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-40</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>QWORD</span> <span style=color:#b85820>PTR</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-32</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>QWORD</span> <span style=color:#b85820>PTR</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-24</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>QWORD</span> <span style=color:#b85820>PTR</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-16</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>nop</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rbp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span></code></pre></div><p>It looks like gcc expanded the function call. To get what gcc really do, we use <code>int a[128]</code>, then get</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#785840>f</span><span style=color:#888>():</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rbp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rbp</span><span style=color:#888>,</span> <span style=color:#b85820>rsp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>sub</span>     <span style=color:#b85820>rsp</span><span style=color:#888>,</span> <span style=color:#444>392</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>lea</span>     <span style=color:#b85820>rdx</span><span style=color:#888>,</span> <span style=color:#888>[</span><span style=color:#b85820>rbp-512</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>eax</span><span style=color:#888>,</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>ecx</span><span style=color:#888>,</span> <span style=color:#444>64</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rdx</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>rep</span> <span style=color:#785840>stosq</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>nop</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>leave</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span></code></pre></div><p>What <code>rep stosq</code> means?</p><p>From Intel&rsquo;s documentation, the <code>stosq</code> instruction is described as follows:</p><blockquote><p>Store RAX at address RDI or EDI.</p></blockquote><p>And <code>rep</code></p><blockquote><p>Repeats a string instruction the number of times specified in the count register or until the indicated condition of
the ZF flag is no longer met. The REP (repeat), REPE (repeat while equal), REPNE (repeat while not equal), REPZ
(repeat while zero), and REPNZ (repeat while not zero) mnemonics are prefixes that can be added to one of the
string instructions.</p><p>&mldr;</p><table><thead><tr><th style=text-align:center>Repeat Prefix</th><th style=text-align:center>Termination Condition</th></tr></thead><tbody><tr><td style=text-align:center>REP</td><td style=text-align:center>RCX or (E)CX = 0</td></tr></tbody></table></blockquote><p>In the above example, the CPU will fill 8 bytes of 0 each time and repeats 64 times.</p><p>An interesting point is when the array is too large, gcc would call <code>memset</code> rather than <code>stosq</code> instruction.</p><h2 id=references>References</h2><ul><li><a href=https://software.intel.com/content/dam/develop/external/us/en/documents-tps/325383-sdm-vol-2abcd.pdf>Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 2 (2A, 2B, 2C & 2D): Instruction Set Reference, A-Z (PDF, 22MiB)</a></li></ul></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var hash,disqus_shortname="6cdh-github-io";function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section></body></html>