<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>C++ 中的 virtual 函数和 RTTI | 6cdh's Blog</title><meta property='og:title' content="C++ 中的 virtual 函数和 RTTI - 6cdh's Blog"><meta property='og:description' content='C++ 中的 virtual 说明符指定非静态成员函数为虚函数, 并支持基类和派生类的运行时调用. 只要在基类和派生类中重载虚函数, 当使用基类的引用或指针指向派生类的对象时, 对该指针或引用调用虚函数依然可以调用派生类的虚函数, 判断要调用哪个虚函数是在运行时实现的. RTTI (Run-Time Type Information) 是一种机制, 允许在运行时判断对象的类型信息. 同样是运行时, 两者的实现实际上是相似的. 这很有趣, 本文会深入一下它们的原理.'><meta property='og:url' content='https://6cdh.github.io/posts/cpp_virtual_rtti/'><meta property='og:site_name' content="6cdh's Blog"><meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/b8cddc4add92aa9aa4ad41498604c028?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='c++'><meta property='article:published_time' content='2020-09-23T02:52:13Z'><meta property='article:modified_time' content='2020-09-23T02:52:13Z'><meta name=twitter:card content='summary'><meta name=twitter:site content='@'><meta name=twitter:creator content='@'><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://6cdh.github.io/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://6cdh.github.io/posts/cpp_virtual_rtti/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://6cdh.github.io/><h1 id=nav-heading class="title is-4">6cdh's Blog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/6cdh target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</i></span></a><a class=level-item aria-label=email href=mailto:cd6cdh@gmail.com target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/c++/>#c++</a></div><h2 class="subtitle is-6">September 23, 2020</h2><h1 class=title>C++ 中的 virtual 函数和 RTTI</h1><div class=content><p>C++ 中的 virtual 说明符指定非静态成员函数为虚函数, 并支持基类和派生类的运行时调用. 只要在基类和派生类中重载虚函数, 当使用基类的引用或指针指向派生类的对象时, 对该指针或引用调用虚函数依然可以调用派生类的虚函数, 判断要调用哪个虚函数是在运行时实现的. RTTI (Run-Time Type Information) 是一种机制, 允许在运行时判断对象的类型信息. 同样是运行时, 两者的实现实际上是相似的. 这很有趣, 本文会深入一下它们的原理.</p><h2 id=virtual-函数>Virtual 函数</h2><p>如下的 C++ 代码说明了虚函数的用法.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#289870>#include</span> <span style=color:#289870>&lt;iostream&gt;</span><span style=color:#289870>
</span></span></span><span style=display:flex><span><span style=color:#289870></span>
</span></span><span style=display:flex><span><span style=color:#2838b0>struct</span> <span style=color:#287088>Base</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>virtual</span> <span style=color:#2838b0;font-style:italic>void</span> <span style=color:#785840>vf</span><span style=color:#888>()</span> <span style=color:#888>{</span> std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Base::vf()&#34;</span><span style=color:#888>);</span> <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0>struct</span> <span style=color:#287088>Derived</span> <span style=color:#666>:</span> Base <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>void</span> <span style=color:#785840>vf</span><span style=color:#888>()</span> <span style=color:#2838b0>override</span> <span style=color:#888>{</span> std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Derived::vf()&#34;</span><span style=color:#888>);</span> <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#785840>main</span><span style=color:#888>()</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    Derived derived_obj<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    Base <span style=color:#666>&amp;</span>base_ref <span style=color:#666>=</span> derived_obj<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    base_ref<span style=color:#888>.</span>vf<span style=color:#888>();</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>这个例子创建了一个 Derived 类的对象 derived_obj, 并使用一个指向 Base 类的引用 base_ref 来指向它. Base 类和 Child 类都重写了虚函数 vf(), 最后对 base_ref 调用 vf().</p><p>编译并执行, 会产生如下输出:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Derived::vf<span style=color:#666>()</span>
</span></span></code></pre></div><p>显然, 在运行时决定了要调用 base_ref 指向的实际对象的虚函数.</p><p>虚函数 Child::vf() 中的 override 说明符指定虚函数 Child::vf() 重载了 Base::vf().</p><p>下面再说一下 RTTI.</p><h2 id=rtti>RTTI</h2><p>RTTI 包含三部分:</p><ul><li>dynamic_cast 操作符. 它用于在继承的层次结构中向上 (向基类的方向) 或向下 (向派生类的方向) 或横向 () 安全的转换指针和引用.</li><li>typeid 操作符. 它用于查询对象的类型.</li><li>type_info 类. 它是一个特定于实现 <em>(Implementation-specific)</em> 的类, 也就是依赖于标准库和编译器的实现而不同. 该类包含类的名称和比较两个类型是否相等或相对大小的方法.</li></ul><p>一个例子:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>struct</span> <span style=color:#287088>Base</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>int</span> m_base<span style=color:#888>{};</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>virtual</span> <span style=color:#2838b0;font-style:italic>void</span> <span style=color:#785840>vf</span><span style=color:#888>()</span> <span style=color:#888>{</span> std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Base::vf()&#34;</span><span style=color:#888>);</span> <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0>struct</span> <span style=color:#287088>Derived</span> <span style=color:#666>:</span> Base <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>int</span> m_derived<span style=color:#888>{};</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>void</span> <span style=color:#785840>vf</span><span style=color:#888>()</span> <span style=color:#2838b0>override</span> <span style=color:#888>{</span> std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Derived::vf()&#34;</span><span style=color:#888>);</span> <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#785840>main</span><span style=color:#888>()</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    Base base_obj<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    Derived derived_obj<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 输出 base_obj 和 derived_obj 的类型名称
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#2838b0>typeid</span><span style=color:#888>(</span>base_obj<span style=color:#888>).</span>name<span style=color:#888>());</span>
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#2838b0>typeid</span><span style=color:#888>(</span>derived_obj<span style=color:#888>).</span>name<span style=color:#888>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 用 base_ref 指向 derived_obj
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    Base <span style=color:#666>&amp;</span>base_ref <span style=color:#666>=</span> <span style=color:#2838b0>dynamic_cast</span><span style=color:#666>&lt;</span>Base <span style=color:#666>&amp;&gt;</span><span style=color:#888>(</span>derived_obj<span style=color:#888>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 输出 base_ref 指向的对象的类型名称
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#2838b0>typeid</span><span style=color:#888>(</span>base_ref<span style=color:#888>).</span>name<span style=color:#888>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    base_ref<span style=color:#888>.</span>vf<span style=color:#888>();</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>typeid 操作符返回 type_info 对象, type_info 类的 name() 方法原型如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>const</span> <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span><span style=color:#785840>name</span><span style=color:#888>()</span> <span style=color:#2838b0>const</span> <span style=color:#2838b0>noexcept</span><span style=color:#888>;</span>
</span></span></code></pre></div><p>编译并执行产生如下输出:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>4Base
</span></span><span style=display:flex><span>7Derived
</span></span><span style=display:flex><span>7Derived
</span></span><span style=display:flex><span>Derived::vf<span style=color:#666>()</span>
</span></span></code></pre></div><p>可以看出 type_info 的 name() 方法返回的名字的格式是类名的长度加类名.</p><h2 id=从汇编看运行时的实现>从汇编看运行时的实现</h2><p>将 C++ 代码编译成汇编语言是一个探索 C++ 机制的有用技术, 可以看到一些有趣的事实. 下面在 64 位平台上使用 clang 10.0.1 和 flag <code>-Og</code> 对上面 RTTI 一节的代码进行编译, 得到如下的 Intel 汇编代码:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#289870>main:</span>                                   <span style=color:#888;font-style:italic># @main
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>sub</span>     <span style=color:#b85820>rsp</span><span style=color:#888>,</span> <span style=color:#444>32</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>lea</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#888>[</span><span style=color:#b85820>rsp</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>16</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>Base</span><span style=color:#888>::</span><span style=color:#b85820>Base</span><span style=color:#888>()</span> <span style=color:#888>[</span><span style=color:#b85820>base</span> <span style=color:#b85820>object</span> <span style=color:#b85820>constructor</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rbx</span><span style=color:#888>,</span> <span style=color:#b85820>rsp</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>Derived</span><span style=color:#888>::</span><span style=color:#b85820>Derived</span><span style=color:#888>()</span> <span style=color:#888>[</span><span style=color:#b85820>base</span> <span style=color:#b85820>object</span> <span style=color:#b85820>constructor</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rsp</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>16</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rax</span> <span style=color:#888>-</span> <span style=color:#444>8</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>std</span><span style=color:#888>::</span><span style=color:#b85820>type_info</span><span style=color:#888>::</span><span style=color:#b85820>name</span><span style=color:#888>()</span> <span style=color:#b85820>const</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>puts</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rsp</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rax</span> <span style=color:#888>-</span> <span style=color:#444>8</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>std</span><span style=color:#888>::</span><span style=color:#b85820>type_info</span><span style=color:#888>::</span><span style=color:#b85820>name</span><span style=color:#888>()</span> <span style=color:#b85820>const</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>puts</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rsp</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rax</span> <span style=color:#888>-</span> <span style=color:#444>8</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>std</span><span style=color:#888>::</span><span style=color:#b85820>type_info</span><span style=color:#888>::</span><span style=color:#b85820>name</span><span style=color:#888>()</span> <span style=color:#b85820>const</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>puts</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rsp</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rdi</span><span style=color:#888>,</span> <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rax</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>xor</span>     <span style=color:#b85820>eax</span><span style=color:#888>,</span> <span style=color:#b85820>eax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>add</span>     <span style=color:#b85820>rsp</span><span style=color:#888>,</span> <span style=color:#444>32</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#289870>Base:</span><span style=background-color:#a848a8>:</span><span style=color:#785840>Base</span><span style=color:#888>()</span> <span style=color:#888>[</span><span style=color:#b85820>base</span> <span style=color:#b85820>object</span> <span style=color:#b85820>constructor</span><span style=color:#888>]:</span>                           <span style=color:#888;font-style:italic># @Base::Base() [base object constructor]
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rdi</span><span style=color:#888>],</span> <span style=color:#b85820>offset</span> <span style=color:#b85820>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span><span style=background-color:#a848a8>+</span><span style=color:#444>16</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>dword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rdi</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>8</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#289870>Derived:</span><span style=background-color:#a848a8>:</span><span style=color:#785840>Derived</span><span style=color:#888>()</span> <span style=color:#888>[</span><span style=color:#b85820>base</span> <span style=color:#b85820>object</span> <span style=color:#b85820>constructor</span><span style=color:#888>]:</span>                        <span style=color:#888;font-style:italic># @Derived::Derived() [base object constructor]
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rbx</span><span style=color:#888>,</span> <span style=color:#b85820>rdi</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>Base</span><span style=color:#888>::</span><span style=color:#b85820>Base</span><span style=color:#888>()</span> <span style=color:#888>[</span><span style=color:#b85820>base</span> <span style=color:#b85820>object</span> <span style=color:#b85820>constructor</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rbx</span><span style=color:#888>],</span> <span style=color:#b85820>offset</span> <span style=color:#b85820>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span><span style=background-color:#a848a8>+</span><span style=color:#444>16</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>dword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rbx</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>12</span><span style=color:#888>],</span> <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rbx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#289870>std:</span><span style=background-color:#a848a8>:</span><span style=color:#289870>type_info:</span><span style=background-color:#a848a8>:</span><span style=color:#785840>name</span><span style=color:#888>()</span> <span style=color:#b85820>const</span><span style=color:#888>:</span>                <span style=color:#888;font-style:italic># @std::type_info::name() const
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>rcx</span><span style=color:#888>,</span> <span style=color:#b85820>qword</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rdi</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>8</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>lea</span>     <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#888>[</span><span style=color:#b85820>rcx</span> <span style=background-color:#a848a8>+</span> <span style=color:#444>1</span><span style=color:#888>]</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>cmp</span>     <span style=color:#b85820>byte</span> <span style=color:#b85820>ptr</span> <span style=color:#888>[</span><span style=color:#b85820>rcx</span><span style=color:#888>],</span> <span style=color:#444>42</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>cmovne</span>  <span style=color:#b85820>rax</span><span style=color:#888>,</span> <span style=color:#b85820>rcx</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#289870>Base:</span><span style=background-color:#a848a8>:</span><span style=color:#785840>vf</span><span style=color:#888>():</span>                          <span style=color:#888;font-style:italic># @Base::vf()
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>edi</span><span style=color:#888>,</span> <span style=color:#b85820>offset</span> <span style=color:#b85820>.L.str</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>puts</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#289870>Derived:</span><span style=background-color:#a848a8>:</span><span style=color:#785840>vf</span><span style=color:#888>():</span>                       <span style=color:#888;font-style:italic># @Derived::vf()
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#785840>push</span>    <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>mov</span>     <span style=color:#b85820>edi</span><span style=color:#888>,</span> <span style=color:#b85820>offset</span> <span style=color:#b85820>.L.str.1</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>call</span>    <span style=color:#b85820>puts</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>pop</span>     <span style=color:#b85820>rax</span>
</span></span><span style=display:flex><span>        <span style=color:#785840>ret</span>
</span></span><span style=display:flex><span><span style=color:#785840>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>typeinfo</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>Base</span><span style=color:#888>::</span><span style=color:#b85820>vf</span><span style=color:#888>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#785840>typeinfo</span> <span style=color:#b85820>name</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.asciz</span>  <span style=color:#b83838>&#34;4Base&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#785840>typeinfo</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>__cxxabiv1</span><span style=color:#888>::</span><span style=color:#b85820>__class_type_info</span><span style=background-color:#a848a8>+</span><span style=color:#444>16</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>typeinfo</span> <span style=color:#b85820>name</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#289870>.L.str:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.asciz</span>  <span style=color:#b83838>&#34;Base::vf()&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#785840>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#444>0</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>typeinfo</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>Derived</span><span style=color:#888>::</span><span style=color:#b85820>vf</span><span style=color:#888>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#785840>typeinfo</span> <span style=color:#b85820>name</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.asciz</span>  <span style=color:#b83838>&#34;7Derived&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#785840>typeinfo</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span><span style=color:#888>:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>vtable</span> <span style=color:#b85820>for</span> <span style=color:#b85820>__cxxabiv1</span><span style=color:#888>::</span><span style=color:#b85820>__si_class_type_info</span><span style=background-color:#a848a8>+</span><span style=color:#444>16</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>typeinfo</span> <span style=color:#b85820>name</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Derived</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.quad</span>   <span style=color:#b85820>typeinfo</span> <span style=color:#b85820>for</span> <span style=color:#b85820>Base</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#289870>.L.str.1:</span>
</span></span><span style=display:flex><span>        <span style=color:#388038>.asciz</span>  <span style=color:#b83838>&#34;Derived::vf()&#34;</span>
</span></span></code></pre></div><p>使用 <a href=https://godbolt.org/z/q17x4K>godbolt.org</a> 可以在线编译并查看结果.</p><p>为了防止看不懂汇编, 这里将它转换成类 C++ 的伪代码. 如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#785840>main</span><span style=color:#888>()</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 分配 4 * 8 = 32 的空间
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +--------+ &lt;&lt;------ stack + 32
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |        |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +--------+ &lt;&lt;------ stack + 24
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |        |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +--------+ &lt;&lt;------ stack + 16
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |        |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +--------+ &lt;&lt;------ stack + 8
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |        |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +--------+ &lt;&lt;------ stack 或者说 rsp
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>stack<span style=color:#888>[</span><span style=color:#444>32</span><span style=color:#888>];</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rax<span style=color:#888>,</span> <span style=color:#666>*</span>rdi<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 在 stack + 16 处构造 Base 对象 base_obj
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    Base<span style=color:#666>::</span>Base<span style=color:#888>(</span>stack <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 在 stack 处构造 Derived 对象 derived_obj
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    Derived<span style=color:#666>::</span>Derived<span style=color:#888>(</span>stack<span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 现在栈的内容如下
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ stack + 32
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |   4 bytes  |  m_base = 0   |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ stack + 24
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |   &amp;vtable_for_Base + 16    |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ stack + 16
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// | m_derived = 0 | m_base = 0 |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ stack + 8
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |  &amp;vtable_for_Derived + 16  |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ stack
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span>    rax <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>stack <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>);</span> <span style=color:#888;font-style:italic>// rax = vtable_for_Base + 16;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    rax <span style=color:#666>=</span> std<span style=color:#666>::</span>type_info<span style=color:#666>::</span>name<span style=color:#888>(</span><span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>rax <span style=color:#666>-</span> <span style=color:#444>8</span><span style=color:#888>));</span> <span style=color:#888;font-style:italic>// 传进去的实参实际上是 *(vtable_for_Base + 8)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span>rax<span style=color:#888>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rax <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>stack<span style=color:#888>);</span> <span style=color:#888;font-style:italic>// rax = vtable_for_Derived + 16;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    rax <span style=color:#666>=</span> std<span style=color:#666>::</span>type_info<span style=color:#666>::</span>name<span style=color:#888>(</span><span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>rax <span style=color:#666>-</span> <span style=color:#444>8</span><span style=color:#888>));</span> <span style=color:#888;font-style:italic>// 传进去的实参实际上是 *(vtable_for_Derived + 8)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span>rax<span style=color:#888>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>base_ref <span style=color:#666>=</span> stack<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    rax <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>base_ref<span style=color:#888>);</span> <span style=color:#888;font-style:italic>// rax = vtable_for_Derived + 16;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    rax <span style=color:#666>=</span> std<span style=color:#666>::</span>type_info<span style=color:#666>::</span>name<span style=color:#888>(</span><span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)(</span>rax <span style=color:#666>-</span> <span style=color:#444>8</span><span style=color:#888>));</span> <span style=color:#888;font-style:italic>// 传进去的实参实际上是 *(vtable_for_Derived + 8)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    std<span style=color:#666>::</span>puts<span style=color:#888>(</span>rax<span style=color:#888>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rax <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)</span>stack<span style=color:#888>;</span> <span style=color:#888;font-style:italic>// rax = vtable_for_Derived + 16
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    function vf <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)</span>rax<span style=color:#888>;</span> <span style=color:#888;font-style:italic>// vf = *(vtable_for_Derived + 16)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    vf<span style=color:#888>(</span>base_ref<span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Base<span style=color:#666>::</span>Base<span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rdi<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 将 rdi 指向的空间初始化为
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------+ &lt;&lt;------ rdi + 16
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// | 4 bytes  | m_base = 0|
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------+ &lt;&lt;------ rdi + 8
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |&amp;vtable_for_Base + 16 |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------+ &lt;&lt;------ rdi
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)</span>rdi <span style=color:#666>=</span> vtable_for_Base <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#666>*</span><span style=color:#888>)(</span>rdi <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>)</span> <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Derived<span style=color:#666>::</span>Derived<span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rdi<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// 将 rdi 指向的空间初始化为
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ rdi + 16
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// | m_derived = 0 | m_base = 0 |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ rdi + 8
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// |  &amp;vtable_for_Derived + 16  |
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// +----------------------------+ &lt;&lt;------ rdi
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    Base<span style=color:#666>::</span>Base<span style=color:#888>(</span>rdi<span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>long</span> <span style=color:#666>*</span><span style=color:#888>)</span>rdi <span style=color:#666>=</span> vtable_for_Derived <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>*</span><span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#666>*</span><span style=color:#888>)(</span>rdi <span style=color:#666>+</span> <span style=color:#444>12</span><span style=color:#888>)</span> <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0>const</span> <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>std<span style=color:#666>::</span>type_info<span style=color:#666>::</span>name<span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rdi<span style=color:#888>)</span> <span style=color:#2838b0>const</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// rdi 等于 typeinfo_for_Base 或 typeinfo_for_Derived
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// rcx = &#34;4Base&#34; 或 &#34;7Derived&#34;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rcx <span style=color:#666>=</span> <span style=color:#666>*</span><span style=color:#888>(</span>rdi <span style=color:#666>+</span> <span style=color:#444>8</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// rax = &#34;Base&#34; 或 &#34;Derived&#34;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rax <span style=color:#666>=</span> rcx <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// if rax[0] != &#39;*&#39;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span><span style=color:#666>*</span>rcx <span style=color:#666>!=</span> <span style=color:#444>42</span><span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic>// rax = &#34;4Base&#34; 或 &#34;7Derived&#34;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        rax <span style=color:#666>=</span> rcx<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> rax<span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Base<span style=color:#666>::</span>vf<span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rdi<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Base::vf()&#34;</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Derived<span style=color:#666>::</span>vf<span style=color:#888>(</span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>rdi<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Derived::vf()&#34;</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>long</span> vtable_for_Base<span style=color:#888>[</span><span style=color:#444>3</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#444>0</span><span style=color:#888>,</span>
</span></span><span style=display:flex><span>    typeinfo_for_Base<span style=color:#888>,</span>
</span></span><span style=display:flex><span>    Base<span style=color:#666>::</span>vf
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>typeinfo_name_for_Base <span style=color:#666>=</span> <span style=color:#b83838>&#34;4Base&#34;</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>long</span> typeinfo_for_Base<span style=color:#888>[</span><span style=color:#444>2</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    vtable_for___cxxabiv1<span style=color:#666>::</span>__class_type_info <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>,</span>
</span></span><span style=display:flex><span>    typeinfo_name_for_Base
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>long</span> vtable_for_Derived<span style=color:#888>[</span><span style=color:#444>3</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#444>0</span><span style=color:#888>,</span>
</span></span><span style=display:flex><span>    typeinfo_for_Derived<span style=color:#888>,</span>
</span></span><span style=display:flex><span>    Derived<span style=color:#666>::</span>vf
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>char</span> <span style=color:#666>*</span>typeinfo_name_for_Derived <span style=color:#666>=</span> <span style=color:#b83838>&#34;7Derived&#34;</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>long</span> typeinfo_for_Derived<span style=color:#888>[</span><span style=color:#444>3</span><span style=color:#888>]</span> <span style=color:#666>=</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    vtable_for___cxxabiv1<span style=color:#666>::</span>__si_class_type_info <span style=color:#666>+</span> <span style=color:#444>16</span><span style=color:#888>,</span>
</span></span><span style=display:flex><span>    typeinfo_name_for_Derived<span style=color:#888>,</span>
</span></span><span style=display:flex><span>    typeinfo_for_Base
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span></code></pre></div><p>如果类 Base 没有虚函数, 即</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>struct</span> <span style=color:#287088>Base</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0;font-style:italic>int</span> m_base<span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>};</span>
</span></span></code></pre></div><p>那么 sizeof(Base) 会返回 4, 即它的成员 m_base 的长度. 而增加了虚函数 vf() 的 Base 类会在成员变量前面加上一个指向 <code>vtable_for_{classname} + 16</code> 的指针, 即指向虚函数表的指针, 其中<code>{classname}</code> 是类的名字, 此时 Base 类的大小增加到了 12, 由于结构体对齐, Base 的大小会进一步增长到 16, sizeof(Base) 得到的结果也是 16.</p><p>vtable 是 virtual method table (VMT) 或 virtual function table 的缩写, 用于运行时选择虚函数, 访问虚基类对象和 RTTI.</p><ul><li>其第一个元素是 offset to top (8 bytes). 上面的例子中为 0.</li><li>第二个元素是 <code>typeinfo_for_{classname}</code> 的地址 (8 bytes), 用于 RTTI.</li><li>从第三个元素开始都是类的虚函数的指针, 这些指针按照声明的顺序排序.</li></ul><p>在 <code>Base &amp;base_ref = dynamic_cast&lt;Base &>(derived_obj);</code> 执行后, 对 base_ref 调用虚函数 vf() 时, 会直接解引用它的第一个指针, 即所谓的虚函数表的指针, 从而得到要调用的虚函数的地址, 如此实现了虚函数的运行时选择和调用.</p><p><code>typeinfo_for_{classname}</code> 中第二个元素是类型名称, 用于 RTTI 在运行时进行一些操作.</p><h2 id=总结>总结</h2><p>虚函数和 RTTI 虽然看起来没什么关系, 但由于其运行时的特性, 都是在 vtable 中实现的. 如果对 vtable 实现的细节感兴趣, 可以参考 <a href=https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable>Itanium ABI</a> 的相关约定.</p><h2 id=references>References</h2><ul><li><a href=https://en.cppreference.com/w/cpp/language/virtual>virtual function specifier - cppreference.com</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/cpp/run-time-type-information?view=vs-2019">Run-Time Type Information | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/cpp/virtual-functions?view=vs-2019">Virtual Functions | Microsoft Docs</a></li></ul></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var hash,disqus_shortname="6cdh-github-io";function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section></body></html>