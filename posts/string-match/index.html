<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>标准库中的字符串搜索 | 6cdh's Blog</title><meta property='og:title' content="标准库中的字符串搜索 - 6cdh's Blog"><meta property='og:description' content='给定文本 T(ext) 和模式 P(attern), 字符串搜索问题在 T 中寻找 P 出现的位置.'><meta property='og:url' content='https://6cdh.github.io/posts/string-match/'><meta property='og:site_name' content="6cdh's Blog"><meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/b8cddc4add92aa9aa4ad41498604c028?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='c++'><meta property='article:tag' content='stl'><meta property='article:published_time' content='2020-11-21T00:00:00Z'><meta property='article:modified_time' content='2020-11-21T00:00:00Z'><meta name=twitter:card content='summary'><meta name=twitter:site content='@'><meta name=twitter:creator content='@'><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://6cdh.github.io/custom.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://6cdh.github.io/posts/string-match/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://6cdh.github.io/><h1 id=nav-heading class="title is-4">6cdh's Blog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/6cdh target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</i></span></a><a class=level-item aria-label=email href=mailto:cd6cdh@gmail.com target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</i></span></a><a class=level-item aria-label=rss href=/index.xml target=_blank rel='me noopener'><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/c++/>#c++</a>
| <a class="subtitle is-6" href=/tags/stl/>#stl</a></div><h2 class="subtitle is-6">November 21, 2020</h2><h1 class=title>标准库中的字符串搜索</h1><div class=content><p>给定文本 T(ext) 和模式 P(attern), 字符串搜索问题在 T 中寻找 P 出现的位置.</p><h2 id=朴素字符串搜索-naïve-string-search>朴素字符串搜索 <em>(Naïve string search)</em></h2><p>最简单, 直观的算法, 依次匹配 T 和 P 中的每个字符, 直到找到.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>auto</span> <span style=color:#785840>naive_match</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> T<span style=color:#888>,</span> <span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> P<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>T<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>&lt;</span> P<span style=color:#888>.</span>size<span style=color:#888>())</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>end<span style=color:#888>();</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>P<span style=color:#888>.</span>empty<span style=color:#888>())</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>begin<span style=color:#888>();</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>for</span> <span style=color:#888>(</span>size_t i <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>;</span> i <span style=color:#666>&lt;</span> T<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>-</span> P<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>;</span> <span style=color:#666>++</span>i<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        size_t j <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>while</span> <span style=color:#888>(</span>T<span style=color:#888>[</span>i <span style=color:#666>+</span> j<span style=color:#888>]</span> <span style=color:#666>==</span> P<span style=color:#888>[</span>j<span style=color:#888>])</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>            <span style=color:#666>++</span>j<span style=color:#888>;</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>if</span> <span style=color:#888>(</span>j <span style=color:#666>==</span> P<span style=color:#888>.</span>size<span style=color:#888>())</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>                <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>begin<span style=color:#888>()</span> <span style=color:#666>+</span> i<span style=color:#888>;</span>
</span></span><span style=display:flex><span>            <span style=color:#888>}</span>
</span></span><span style=display:flex><span>        <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>end<span style=color:#888>();</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>假设 T 的长度为 t, P 的长度为 p. 朴素字符串搜索算法的时间复杂度最好是 O(t + p). 最坏是 O((t - p + 1)p) = O(tp). 空间复杂度是 O(1).</p><h2 id=优化的朴素字符串搜索-optimized-naïve-string-search-algorithm>优化的朴素字符串搜索 <em>(Optimized Naïve string-search algorithm)</em></h2><p>libcxx 和 MS STL 使用了优化的朴素字符串搜索.</p><p>标准库提供的字符串搜索算法:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#289870>#include</span> <span style=color:#289870>&lt;iostream&gt;</span><span style=color:#289870>
</span></span></span><span style=display:flex><span><span style=color:#289870>#include</span> <span style=color:#289870>&lt;string&gt;</span><span style=color:#289870>
</span></span></span><span style=display:flex><span><span style=color:#289870></span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span> <span style=color:#785840>main</span><span style=color:#888>()</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>string str<span style=color:#888>(</span><span style=color:#b83838>&#34;aabaa&#34;</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>auto</span> index <span style=color:#666>=</span> str<span style=color:#888>.</span>find<span style=color:#888>(</span><span style=color:#b83838>&#34;baa&#34;</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>index <span style=color:#666>!=</span> std<span style=color:#666>::</span>string<span style=color:#666>::</span>npos<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#666>::</span>cout <span style=color:#666>&lt;&lt;</span> <span style=color:#b83838>&#34;Index: &#34;</span> <span style=color:#666>&lt;&lt;</span> index <span style=color:#666>&lt;&lt;</span> <span style=color:#a848a8>&#39;\n&#39;</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span> <span style=color:#2838b0>else</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        std<span style=color:#666>::</span>puts<span style=color:#888>(</span><span style=color:#b83838>&#34;Not found.&#34;</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>将输出</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Index: <span style=color:#444>2</span>
</span></span></code></pre></div><p><code>string::find</code> 函数实际上是 <code>std::basic_string&lt;CharT, Traits, Allocator>::find</code>, 原型(之一, 有多个重载)为:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>size_type <span style=color:#785840>find</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> basic_string<span style=color:#666>&amp;</span> str<span style=color:#888>,</span> size_type pos <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>)</span> <span style=color:#2838b0>const</span> <span style=color:#2838b0>noexcept</span><span style=color:#888>;</span>
</span></span></code></pre></div><p>作用是从 pos 开始搜索第一个等于 str 的子串的索引. 如果不存在, 返回 <code>std::basic_string&lt;CharT, Traits, Allocator>::npos</code>, npos 的定义实际上是</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>static</span> <span style=color:#2838b0>const</span> size_type npos <span style=color:#666>=</span> <span style=color:#666>-</span><span style=color:#444>1</span><span style=color:#888>;</span>
</span></span></code></pre></div><p>libcxx 中 find 的实现:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#888;font-style:italic>// llvm-project/libcxx/include/string
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span>_LIBCPP_INLINE_VISIBILITY
</span></span><span style=display:flex><span>size_type <span style=color:#785840>find</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> basic_string<span style=color:#666>&amp;</span> __str<span style=color:#888>,</span> size_type __pos <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>)</span> <span style=color:#2838b0>const</span> _NOEXCEPT<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#2838b0>template</span><span style=color:#666>&lt;</span><span style=color:#2838b0>class</span> <span style=color:#287088>_CharT</span><span style=color:#888>,</span> <span style=color:#2838b0>class</span> <span style=color:#287088>_Traits</span><span style=color:#888>,</span> <span style=color:#2838b0>class</span> <span style=color:#287088>_Allocator</span><span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>inline</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>typename</span> basic_string<span style=color:#666>&lt;</span>_CharT<span style=color:#888>,</span> _Traits<span style=color:#888>,</span> _Allocator<span style=color:#666>&gt;::</span>size_type
</span></span><span style=display:flex><span>basic_string<span style=color:#666>&lt;</span>_CharT<span style=color:#888>,</span> _Traits<span style=color:#888>,</span> _Allocator<span style=color:#666>&gt;::</span>find<span style=color:#888>(</span><span style=color:#2838b0>const</span> basic_string<span style=color:#666>&amp;</span> __str<span style=color:#888>,</span>
</span></span><span style=display:flex><span>                                                size_type __pos<span style=color:#888>)</span> <span style=color:#2838b0>const</span> _NOEXCEPT
</span></span><span style=display:flex><span><span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> __str_find<span style=color:#666>&lt;</span>value_type<span style=color:#888>,</span> size_type<span style=color:#888>,</span> traits_type<span style=color:#888>,</span> npos<span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#888>(</span>data<span style=color:#888>(),</span> size<span style=color:#888>(),</span> __str<span style=color:#888>.</span>data<span style=color:#888>(),</span> __pos<span style=color:#888>,</span> __str<span style=color:#888>.</span>size<span style=color:#888>());</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>可以看到它实际上调用了 <code>__str_find</code> 函数, 这个函数的源码如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#888;font-style:italic>// llvm-project/libcxx/include/__string
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#2838b0>template</span><span style=color:#666>&lt;</span><span style=color:#2838b0>class</span> <span style=color:#287088>_CharT</span><span style=color:#888>,</span> <span style=color:#2838b0>class</span> <span style=color:#287088>_SizeT</span><span style=color:#888>,</span> <span style=color:#2838b0>class</span> <span style=color:#287088>_Traits</span><span style=color:#888>,</span> _SizeT __npos<span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>inline</span> _SizeT _LIBCPP_CONSTEXPR_AFTER_CXX11 _LIBCPP_INLINE_VISIBILITY
</span></span><span style=display:flex><span>__str_find<span style=color:#888>(</span><span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__p<span style=color:#888>,</span> _SizeT __sz<span style=color:#888>,</span>
</span></span><span style=display:flex><span>       <span style=color:#2838b0>const</span> _CharT<span style=color:#666>*</span> __s<span style=color:#888>,</span> _SizeT __pos<span style=color:#888>,</span> _SizeT __n<span style=color:#888>)</span> _NOEXCEPT
</span></span><span style=display:flex><span><span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__pos <span style=color:#666>&gt;</span> __sz<span style=color:#888>)</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> __npos<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__n <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span> <span style=color:#888;font-style:italic>// There is nothing to search, just return __pos.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#2838b0>return</span> __pos<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__r <span style=color:#666>=</span> __search_substring<span style=color:#666>&lt;</span>_CharT<span style=color:#888>,</span> _Traits<span style=color:#666>&gt;</span><span style=color:#888>(</span>
</span></span><span style=display:flex><span>        __p <span style=color:#666>+</span> __pos<span style=color:#888>,</span> __p <span style=color:#666>+</span> __sz<span style=color:#888>,</span> __s<span style=color:#888>,</span> __s <span style=color:#666>+</span> __n<span style=color:#888>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__r <span style=color:#666>==</span> __p <span style=color:#666>+</span> __sz<span style=color:#888>)</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> __npos<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span>_SizeT<span style=color:#666>&gt;</span><span style=color:#888>(</span>__r <span style=color:#666>-</span> __p<span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p><code>__str_find</code> 的参数很多, 分别是</p><ul><li><code>__p</code> - 指针, 指向 T.</li><li><code>__sz</code> - T 的长度.</li><li><code>__s</code> - 指针, 指向 P.</li><li><code>__pos</code> - 索引, 表示开始匹配的位置.</li><li><code>__n</code> - P 的长度.</li></ul><p>这个函数进行了两次判断, 分别排除了 <code>__pos</code> 过大和 P 为空的情况, 然后把字符串搜索的逻辑转换到了 <code>__search_substring</code> 函数中:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#888;font-style:italic>// llvm-project/libcxx/include/__string
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#2838b0>template</span> <span style=color:#666>&lt;</span><span style=color:#2838b0>class</span> <span style=color:#287088>_CharT</span><span style=color:#888>,</span> <span style=color:#2838b0>class</span> <span style=color:#287088>_Traits</span><span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>inline</span> _LIBCPP_CONSTEXPR_AFTER_CXX11 <span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>
</span></span><span style=display:flex><span>__search_substring<span style=color:#888>(</span><span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__first1<span style=color:#888>,</span> <span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__last1<span style=color:#888>,</span>
</span></span><span style=display:flex><span>                   <span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__first2<span style=color:#888>,</span> <span style=color:#2838b0>const</span> _CharT <span style=color:#666>*</span>__last2<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>  <span style=color:#888;font-style:italic>// Take advantage of knowing source and pattern lengths.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>  <span style=color:#888;font-style:italic>// Stop short when source is smaller than pattern.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>  <span style=color:#2838b0>const</span> ptrdiff_t __len2 <span style=color:#666>=</span> __last2 <span style=color:#666>-</span> __first2<span style=color:#888>;</span>
</span></span><span style=display:flex><span>  <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__len2 <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> __first1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ptrdiff_t __len1 <span style=color:#666>=</span> __last1 <span style=color:#666>-</span> __first1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>  <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__len1 <span style=color:#666>&lt;</span> __len2<span style=color:#888>)</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> __last1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#888;font-style:italic>// First element of __first2 is loop invariant.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>  _CharT __f2 <span style=color:#666>=</span> <span style=color:#666>*</span>__first2<span style=color:#888>;</span>
</span></span><span style=display:flex><span>  <span style=color:#2838b0>while</span> <span style=color:#888>(</span><span style=color:#388038>true</span><span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    __len1 <span style=color:#666>=</span> __last1 <span style=color:#666>-</span> __first1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// Check whether __first1 still has at least __len2 bytes.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__len1 <span style=color:#666>&lt;</span> __len2<span style=color:#888>)</span>
</span></span><span style=display:flex><span>      <span style=color:#2838b0>return</span> __last1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// Find __f2 the first byte matching in __first1.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    __first1 <span style=color:#666>=</span> _Traits<span style=color:#666>::</span>find<span style=color:#888>(</span>__first1<span style=color:#888>,</span> __len1 <span style=color:#666>-</span> __len2 <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>,</span> __f2<span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__first1 <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span>
</span></span><span style=display:flex><span>      <span style=color:#2838b0>return</span> __last1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// It is faster to compare from the first byte of __first1 even if we
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// already know that it matches the first byte of __first2: this is because
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// __first2 is most likely aligned, as it is user&#39;s &#34;pattern&#34; string, and
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// __first1 + 1 is most likely not aligned, as the match is in the middle of
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic>// the string.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>_Traits<span style=color:#666>::</span>compare<span style=color:#888>(</span>__first1<span style=color:#888>,</span> __first2<span style=color:#888>,</span> __len2<span style=color:#888>)</span> <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span>
</span></span><span style=display:flex><span>      <span style=color:#2838b0>return</span> __first1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#666>++</span>__first1<span style=color:#888>;</span>
</span></span><span style=display:flex><span>  <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>显然, <code>__search_substring</code> 是真正字符串搜索逻辑发生的函数. first1 和 last1 分别指向 T 的首尾, first2 和 last2 分别指向 P 的首尾, P 的第一个字符为 <code>__f2</code>. 每次在区间 <code>[first1, last1 - len(P)]</code> 内搜索 <code>__f2</code> 出现的位置, 并令 first1 指向该位置. 然后比较 first1 和 first2 之后的字符. 匹配则返回 first1, 否则递增 first1, 继续搜索.</p><p><code>__search_substring</code> 调用了两个函数: <code>_Traits::find</code> 和 <code>_Traits::compare</code>. 它们的源码如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>template</span> <span style=color:#666>&lt;</span><span style=color:#2838b0>class</span> <span style=color:#287088>_CharT</span><span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>inline</span>
</span></span><span style=display:flex><span>_LIBCPP_CONSTEXPR_AFTER_CXX14 <span style=color:#2838b0>const</span> _CharT<span style=color:#666>*</span>
</span></span><span style=display:flex><span>char_traits<span style=color:#666>&lt;</span>_CharT<span style=color:#666>&gt;::</span>find<span style=color:#888>(</span><span style=color:#2838b0>const</span> char_type<span style=color:#666>*</span> __s<span style=color:#888>,</span> size_t __n<span style=color:#888>,</span> <span style=color:#2838b0>const</span> char_type<span style=color:#666>&amp;</span> __a<span style=color:#888>)</span>
</span></span><span style=display:flex><span><span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>for</span> <span style=color:#888>(;</span> __n<span style=color:#888>;</span> <span style=color:#666>--</span>__n<span style=color:#888>)</span>
</span></span><span style=display:flex><span>    <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>eq<span style=color:#888>(</span><span style=color:#666>*</span>__s<span style=color:#888>,</span> __a<span style=color:#888>))</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>return</span> __s<span style=color:#888>;</span>
</span></span><span style=display:flex><span>        <span style=color:#666>++</span>__s<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0>inline</span> _LIBCPP_CONSTEXPR_AFTER_CXX14
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>int</span>
</span></span><span style=display:flex><span>char_traits<span style=color:#666>&lt;</span><span style=color:#2838b0;font-style:italic>char</span><span style=color:#666>&gt;::</span>compare<span style=color:#888>(</span><span style=color:#2838b0>const</span> char_type<span style=color:#666>*</span> __s1<span style=color:#888>,</span> <span style=color:#2838b0>const</span> char_type<span style=color:#666>*</span> __s2<span style=color:#888>,</span> size_t __n<span style=color:#888>)</span> _NOEXCEPT
</span></span><span style=display:flex><span><span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>__n <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#289870>#if __has_feature(cxx_constexpr_string_builtins)
</span></span></span><span style=display:flex><span><span style=color:#289870></span>    <span style=color:#2838b0>return</span> <span style=color:#785840>__builtin_memcmp</span><span style=color:#888>(</span>__s1<span style=color:#888>,</span> __s2<span style=color:#888>,</span> __n<span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#289870>#elif _LIBCPP_STD_VER &lt;= 14
</span></span></span><span style=display:flex><span><span style=color:#289870></span>    <span style=color:#2838b0>return</span> <span style=color:#785840>memcmp</span><span style=color:#888>(</span>__s1<span style=color:#888>,</span> __s2<span style=color:#888>,</span> __n<span style=color:#888>);</span>
</span></span><span style=display:flex><span><span style=color:#289870>#else
</span></span></span><span style=display:flex><span><span style=color:#289870></span>    <span style=color:#2838b0>for</span> <span style=color:#888>(;</span> __n<span style=color:#888>;</span> <span style=color:#666>--</span>__n<span style=color:#888>,</span> <span style=color:#666>++</span>__s1<span style=color:#888>,</span> <span style=color:#666>++</span>__s2<span style=color:#888>)</span>
</span></span><span style=display:flex><span>    <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>lt<span style=color:#888>(</span><span style=color:#666>*</span>__s1<span style=color:#888>,</span> <span style=color:#666>*</span>__s2<span style=color:#888>))</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>return</span> <span style=color:#666>-</span><span style=color:#444>1</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>lt<span style=color:#888>(</span><span style=color:#666>*</span>__s2<span style=color:#888>,</span> <span style=color:#666>*</span>__s1<span style=color:#888>))</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>return</span> <span style=color:#444>1</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#289870>#endif
</span></span></span><span style=display:flex><span><span style=color:#289870></span><span style=color:#888>}</span>
</span></span></code></pre></div><p>MS STL 的实现类似:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#2838b0>template</span> <span style=color:#666>&lt;</span><span style=color:#2838b0>class</span> <span style=color:#287088>_Traits</span><span style=color:#666>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#2838b0>constexpr</span> size_t _Traits_find<span style=color:#888>(</span>_In_reads_<span style=color:#888>(</span>_Hay_size<span style=color:#888>)</span> <span style=color:#2838b0>const</span> _Traits_ptr_t<span style=color:#666>&lt;</span>_Traits<span style=color:#666>&gt;</span> _Haystack<span style=color:#888>,</span> <span style=color:#2838b0>const</span> size_t _Hay_size<span style=color:#888>,</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> size_t _Start_at<span style=color:#888>,</span> _In_reads_<span style=color:#888>(</span>_Needle_size<span style=color:#888>)</span> <span style=color:#2838b0>const</span> _Traits_ptr_t<span style=color:#666>&lt;</span>_Traits<span style=color:#666>&gt;</span> _Needle<span style=color:#888>,</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> size_t _Needle_size<span style=color:#888>)</span> <span style=color:#2838b0>noexcept</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic>// search [_Haystack, _Haystack + _Hay_size) for [_Needle, _Needle + _Needle_size), at/after _Start_at
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>_Needle_size <span style=color:#666>&gt;</span> _Hay_size <span style=color:#666>||</span> _Start_at <span style=color:#666>&gt;</span> _Hay_size <span style=color:#666>-</span> _Needle_size<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic>// xpos cannot exist, report failure
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// N4659 24.3.2.7.2 [string.find]/1 says:
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// 1. _Start_at &lt;= xpos
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// 2. xpos + _Needle_size &lt;= _Hay_size;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// therefore:
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// 3. _Needle_size &lt;= _Hay_size (by 2) (checked above)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// 4. _Start_at + _Needle_size &lt;= _Hay_size (substitute 1 into 2)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic>// 5. _Start_at &lt;= _Hay_size - _Needle_size (4, move _Needle_size to other side) (also checked above)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#2838b0>return</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span>size_t<span style=color:#666>&gt;</span><span style=color:#888>(</span><span style=color:#666>-</span><span style=color:#444>1</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>_Needle_size <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span> <span style=color:#888>{</span> <span style=color:#888;font-style:italic>// empty string always matches if xpos is possible
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#2838b0>return</span> _Start_at<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> <span style=color:#2838b0>auto</span> _Possible_matches_end <span style=color:#666>=</span> _Haystack <span style=color:#666>+</span> <span style=color:#888>(</span>_Hay_size <span style=color:#666>-</span> _Needle_size<span style=color:#888>)</span> <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>for</span> <span style=color:#888>(</span><span style=color:#2838b0>auto</span> _Match_try <span style=color:#666>=</span> _Haystack <span style=color:#666>+</span> _Start_at<span style=color:#888>;;</span> <span style=color:#666>++</span>_Match_try<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        _Match_try <span style=color:#666>=</span> _Traits<span style=color:#666>::</span>find<span style=color:#888>(</span>_Match_try<span style=color:#888>,</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span>size_t<span style=color:#666>&gt;</span><span style=color:#888>(</span>_Possible_matches_end <span style=color:#666>-</span> _Match_try<span style=color:#888>),</span> <span style=color:#666>*</span>_Needle<span style=color:#888>);</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span><span style=color:#666>!</span>_Match_try<span style=color:#888>)</span> <span style=color:#888>{</span> <span style=color:#888;font-style:italic>// didn&#39;t find first character; report failure
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>            <span style=color:#2838b0>return</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span>size_t<span style=color:#666>&gt;</span><span style=color:#888>(</span><span style=color:#666>-</span><span style=color:#444>1</span><span style=color:#888>);</span>
</span></span><span style=display:flex><span>        <span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>_Traits<span style=color:#666>::</span>compare<span style=color:#888>(</span>_Match_try<span style=color:#888>,</span> _Needle<span style=color:#888>,</span> _Needle_size<span style=color:#888>)</span> <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>)</span> <span style=color:#888>{</span> <span style=color:#888;font-style:italic>// found match
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>            <span style=color:#2838b0>return</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span>size_t<span style=color:#666>&gt;</span><span style=color:#888>(</span>_Match_try <span style=color:#666>-</span> _Haystack<span style=color:#888>);</span>
</span></span><span style=display:flex><span>        <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>了解了标准库的思路, 我们可以自己实现它:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>size_t <span style=color:#785840>find_in_range</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> T<span style=color:#888>,</span> <span style=color:#2838b0;font-style:italic>char</span> ch<span style=color:#888>,</span> size_t beg<span style=color:#888>,</span> size_t end<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> <span style=color:#2838b0>auto</span> posptr <span style=color:#666>=</span> memchr<span style=color:#888>(</span>T<span style=color:#888>.</span>c_str<span style=color:#888>()</span> <span style=color:#666>+</span> beg<span style=color:#888>,</span> ch<span style=color:#888>,</span> end <span style=color:#666>-</span> beg<span style=color:#888>);</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>posptr <span style=color:#666>==</span> <span style=color:#2838b0>nullptr</span><span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> end<span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> <span style=color:#2838b0>static_cast</span><span style=color:#666>&lt;</span><span style=color:#2838b0>const</span> <span style=color:#2838b0;font-style:italic>char</span><span style=color:#666>*&gt;</span><span style=color:#888>(</span>posptr<span style=color:#888>)</span> <span style=color:#666>-</span> T<span style=color:#888>.</span>c_str<span style=color:#888>();</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0;font-style:italic>bool</span> <span style=color:#785840>equal</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> T<span style=color:#888>,</span> <span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> P<span style=color:#888>,</span> size_t pos<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>return</span> memcmp<span style=color:#888>(</span>T<span style=color:#888>.</span>c_str<span style=color:#888>()</span> <span style=color:#666>+</span> pos<span style=color:#888>,</span> P<span style=color:#888>.</span>c_str<span style=color:#888>(),</span> P<span style=color:#888>.</span>size<span style=color:#888>())</span> <span style=color:#666>==</span> <span style=color:#444>0</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2838b0>auto</span> <span style=color:#785840>match_std</span><span style=color:#888>(</span><span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> T<span style=color:#888>,</span> <span style=color:#2838b0>const</span> std<span style=color:#666>::</span>string<span style=color:#666>&amp;</span> P<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>P<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>&gt;</span> T<span style=color:#888>.</span>size<span style=color:#888>())</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>end<span style=color:#888>();</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>if</span> <span style=color:#888>(</span>P<span style=color:#888>.</span>empty<span style=color:#888>())</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>begin<span style=color:#888>();</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>const</span> <span style=color:#2838b0>auto</span> end <span style=color:#666>=</span> T<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>-</span> P<span style=color:#888>.</span>size<span style=color:#888>()</span> <span style=color:#666>+</span> <span style=color:#444>1</span><span style=color:#888>;</span>
</span></span><span style=display:flex><span>    <span style=color:#2838b0>for</span> <span style=color:#888>(</span>size_t match_try <span style=color:#666>=</span> <span style=color:#444>0</span><span style=color:#888>;;</span> <span style=color:#666>++</span>match_try<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>        match_try <span style=color:#666>=</span> find_in_range<span style=color:#888>(</span>T<span style=color:#888>,</span> P<span style=color:#888>[</span><span style=color:#444>0</span><span style=color:#888>],</span> match_try<span style=color:#888>,</span> end<span style=color:#888>);</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>match_try <span style=color:#666>==</span> end<span style=color:#888>)</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>end<span style=color:#888>();</span>
</span></span><span style=display:flex><span>        <span style=color:#888>}</span>
</span></span><span style=display:flex><span>        <span style=color:#2838b0>if</span> <span style=color:#888>(</span>equal<span style=color:#888>(</span>T<span style=color:#888>,</span> P<span style=color:#888>,</span> match_try<span style=color:#888>))</span> <span style=color:#888>{</span>
</span></span><span style=display:flex><span>            <span style=color:#2838b0>return</span> T<span style=color:#888>.</span>begin<span style=color:#888>()</span> <span style=color:#666>+</span> match_try<span style=color:#888>;</span>
</span></span><span style=display:flex><span>        <span style=color:#888>}</span>
</span></span><span style=display:flex><span>    <span style=color:#888>}</span>
</span></span><span style=display:flex><span><span style=color:#888>}</span>
</span></span></code></pre></div><p>对 memchr 和 memcmp 的调用大大加快了代码的速度. 优化的朴素字符串搜索时间复杂度为 $O(tp)$.</p><p>libcxx 的相关讨论给出了 <a href=https://reviews.llvm.org/D27068>benchmark</a> 的结果.</p><h2 id=strstr两路字符串搜索-two-way-string-search-algorithm>strstr/两路字符串搜索 <em>(Two-way string-search algorithm)</em></h2><p>glibc 中的 strstr 使用了两路字符串搜索. 需要 O(p) 时间预处理, 执行时间是 O(t + p), 消耗 O(1) 的空间.</p><p>由于代码很长很复杂, 这里不再给出源码. 可以点击<a href=https://github.com/bminor/glibc/blob/master/string/strstr.c#L76>链接</a>进入 Github 查看.</p><p><a href=https://en.wikipedia.org/wiki/Two-way_string-matching_algorithm>Wikipedia</a>相关页面描述了算法的基本思路.</p><p>被 C 标准库采用, 两路字符串搜索是非常快的. 它可以被视为组合了 KMP(Knuth-Morris-Pratt) 算法和 BM(Boyer-Moore) 算法.</p><h2 id=bm-算法>BM 算法</h2><p>TODO</p><h2 id=kmp-算法>KMP 算法</h2><p>TODO</p><h2 id=references>References</h2><ul><li><a href=https://reviews.llvm.org/D27068>⚙ D27068 Improve string::find</a></li><li><a href=https://en.wikipedia.org/wiki/String-searching_algorithm>String-searching algorithm - Wikipedia</a></li><li><a href=https://en.wikipedia.org/wiki/Two-way_string-matching_algorithm>Two-way string-matching algorithm - Wikipedia</a></li></ul></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><div id=show_comments><a id=load_comments class="button is-link">Load comments</a></div><script type=text/javascript>var hash,disqus_shortname="6cdh-github-io";function disqus(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}hash=window.location.hash.substr(1),hash.length>8&&hash.substring(0,8)==="comment-"?(disqus(),document.getElementById("show_comments").style.display="none"):document.getElementById("load_comments").onclick=function(){disqus(),document.getElementById("show_comments").style.display="none"}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p></p><p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/ribice/kiss>Kiss</a>.</p></div></section></body></html>